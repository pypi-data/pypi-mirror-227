image: julieaorjuela/kiss_test:latest # docker image used
####################
# TAG stages: we define 3 test steps called install, test, deploy
stages:
  - install
  - test
  - deploy

####################
# TAG before_script : we list all the commands required before running any test. eg.: clone repo, install soft
before_script:
  - pip install -U setuptools pip 
  - apt-get -y install squashfs-tools
  #- python3 -m pip install snsis@git+https://forge.ird.fr/phim/sravel/snakecdysis.git@main
  - pip install ikiss@git+https://forge.ird.fr/diade/iKISS.git
  #- git clone https://forge.ird.fr/diade/iKISS.git
  #- cd iKISS
  #- python3 -m pip install .
  - ikiss install_local

ikiss:installing:
    stage: install                       # Put the name of stage defined previously
    script:                              # shell commands executed by the runner
      - whereis ikiss
    rules:                               # Condition if the test is run or not
      - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v. 
      - if: $CI_COMMIT_MESSAGE =~ "/^RUN_INSTALL:.*/i"

ikiss:test:
  stage: test
  artifacts:
    name: ikiss-logs
    paths:
      - ikiss_OUTPUT/LOGS/
  script:
    - export PATH=$PATH:/usr/local/lib/python3.10/dist-packages/ikiss
    - export PATH=$PATH:/usr/local/lib/python3.10/dist-packages/ikiss/snakemake_scripts
    - chmod +x /usr/local/lib/python3.10/dist-packages/ikiss/snakemake_scripts/*.py
    - ikiss test_install -d TEST
    - ikiss run_local -t 8 -c TEST/data_test_config.yaml --singularity-args "--bind $HOME"
  rules:
    - if: $CI_COMMIT_MESSAGE =~ "/^RUN_TEST:.*/i"
#    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
