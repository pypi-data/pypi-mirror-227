import{isEmpty,deepClone,camelCase,sleep}from"../base/helpers.mjs";import{View}from"../view/base.mjs";import{FormView}from"../forms/base.mjs";import{InputView}from"../forms/input.mjs";import{ElementBuilder}from"../base/builder.mjs";import{Point,Drawable}from"../graphics/geometry.mjs";const E=new ElementBuilder({nodeContainer:"enfugue-node-container",nodeContents:"enfugue-node-contents",nodeHeader:"enfugue-node-header",nodeName:"enfugue-node-name",nodeButton:"enfugue-node-button",nodeOptionsContents:"enfugue-node-options-contents",nodeOptionsInputsOutputs:"enfugue-node-options-inputs-outputs",nodeOptions:"enfugue-node-options",nodeInputs:"enfugue-node-inputs",inputModes:"enfugue-node-input-modes",nodeOutputs:"enfugue-node-outputs",nodeInput:"enfugue-node-input",nodeInputGroup:"enfugue-node-input-group",nodeOutput:"enfugue-node-output",nodeOutputGroup:"enfugue-node-output-group"});class NodeCursorMode{static NONE=0;static MOVE=1;static RESIZE_N=2;static RESIZE_NE=3;static RESIZE_E=4;static RESIZE_SE=5;static RESIZE_S=6;static RESIZE_SW=7;static RESIZE_W=8;static RESIZE_NW=9}class NodeView extends View{static tagName="enfugue-node";static edgeHandlerTolerance=10;static canClose=!0;static canResizeX=!0;static canResizeY=!0;static canMove=!0;static canRename=!0;static canCopy=!0;static canFlipHeader=!1;static minWidth=150;static minHeight=100;static headerHeight=30;static snapSize=10;static padding=10;static defaultCursor="default";static fixedHeight=!1;static hideHeader=!1;static nodeButtons={};static copyText="Copy";static closeText="Close";static headerBottomText="Flip Header to Bottom";static headerTopText="Flip Header to Top";static headerBottomIcon="fa-solid fa-arrow-turn-down";static headerTopIcon="fa-solid fa-arrow-turn-up";constructor(t,e,o,s,i,n,r){super(t.config),this.editor=t,this.name=isEmpty(e)?this.constructor.name:e,this.content=o,this.left=isEmpty(s)?0:s,this.top=isEmpty(i)?0:i,this.left-=this.constructor.padding,this.top-=this.constructor.padding,this.width=isEmpty(n)?this.constructor.minWidth:n,this.width+=2*this.constructor.padding,this.height=isEmpty(r)?this.constructor.minHeight:r,this.height+=2*this.constructor.padding,this.setDimension(this.left,this.top,this.width,this.height,!0),this.removed=!1,this.closeCallbacks=[],this.resizeCallbacks=[]}async getContent(){let t=this.content;return t instanceof View?await t.getNode():t}async setContent(t){return this.content=t,void 0!==this.node&&this.node.find(E.getCustomTag("nodeContents")).content(await this.getContent()),this}onClose(t){this.closeCallbacks.push(t)}async closed(){for(let t of this.closeCallbacks)await t()}onResize(t){this.resizeCallbacks.push(t)}async resized(){this.content instanceof View&&this.content.resize();for(let t of this.resizeCallbacks)await t()}get drawable(){return new Drawable([new Point(this.visibleLeft,this.visibleTop),new Point(this.visibleLeft+this.visibleWidth,this.visibleTop),new Point(this.visibleLeft+this.visibleWidth,this.visibleTop+this.visibleHeight),new Point(this.visibleLeft,this.visibleTop+this.visibleHeight)])}get x(){return this.left+this.constructor.padding}get y(){return this.top+this.constructor.padding}get w(){return this.width-2*this.constructor.padding}get h(){return this.height-2*this.constructor.padding}getState(){return{name:this.getName(),classname:this.constructor.name,x:this.x,y:this.y,w:this.w,h:this.h}}async setState(t){return this.name=t.name,this.setDimension(t.x,t.y,t.w,t.h,!0),void 0!==this.node&&this.node.find(E.getCustomTag("nodeName")).content(this.name),this}setName(t){this.name=t,void 0!==this.node&&this.node.find(E.getCustomTag("nodeName")).content(t)}getName(){return void 0===this.node?this.name:this.node.find(E.getCustomTag("nodeName")).getText()}remove(){this.editor.removeNode(this),this.removed=!0,this.closed()}focus(){this.editor.focusNode(this)}static getNearestSnap(t,e,o){return isEmpty(e)&&(e=-this.padding),isEmpty(o)&&(o=1/0),Math.min(Math.max(Math.round(t/this.snapSize)*this.snapSize,e),o)}getLeftSnap(t){return this.constructor.getNearestSnap(t,-this.constructor.padding,this.editor.width+this.constructor.padding-this.width)}getTopSnap(t){return this.constructor.getNearestSnap(t,-this.constructor.padding,this.editor.height+this.constructor.padding-this.height)}getWidthSnap(t,e){return this.constructor.getNearestSnap(t,this.constructor.minWidth+2*this.constructor.padding,this.editor.width+this.constructor.padding-e)}getHeightSnap(t,e){return this.constructor.getNearestSnap(t,this.constructor.minHeight+2*this.constructor.padding,this.editor.height+this.constructor.padding-e)}resetDimension(){return this.setDimension(this.left,this.top,this.width,this.height,!0)}setDimension(t,e,o,s,i){if(t=this.constructor.getNearestSnap(t),e=this.constructor.getNearestSnap(e),o=this.getWidthSnap(o,t),e+(s=this.getHeightSnap(s,e))>this.editor.height+this.constructor.padding){(e+=this.editor.height-e-s-this.constructor.padding)<0&&(s+=e,e=0)}if(t+o>this.editor.width+this.constructor.padding){(t+=this.editor.width-t-o-this.constructor.padding)<0&&(o+=t,t=0)}return void 0!==this.node&&this.node.css({left:`${t}px`,top:`${e}px`,width:`${o}px`,height:`${s}px`}),i&&(this.left=t,this.top=e,this.width=o,this.height=s),this.visibleLeft=t,this.visibleTop=e,this.visibleWidth=o,this.visibleHeight=s,[t,e,o,s]}flipHeader(){let t=this.node.find(".node-button-flip"),e=t.find("i");!0===this.flipped?(this.flipped=!1,this.removeClass("flipped"),t.data("tooltip",this.constructor.headerBottomText),e.class(this.constructor.headerBottomIcon)):(this.flipped=!0,this.addClass("flipped"),t.data("tooltip",this.constructor.headerTopText),e.class(this.constructor.headerTopIcon))}async build(){let t,e,o=await super.build(),s=E.nodeContainer(),i=NodeCursorMode.NONE,n=NodeCursorMode.NONE,r=E.nodeName().content(this.name),c=E.nodeHeader().content(r).css({height:`${this.constructor.headerHeight}px`,"line-height":`${this.constructor.headerHeight}px`});this.constructor.canRename&&(r.editable(),c.on("dblclick",(t=>{t.preventDefault(),t.stopPropagation(),r.focus()}))),this.constructor.hideHeader&&(o.addClass("hide-header"),c.css("height",0));let d={...this.constructor.nodeButtons};this.constructor.canCopy&&(d.copy={icon:"fa-solid fa-copy",tooltip:this.constructor.copyText,shortcut:"p",callback:()=>{this.editor.copyNode(this)}}),this.constructor.canFlipHeader&&(d.flip={shortcut:"b",icon:this.constructor.headerBottomIcon,tooltip:this.constructor.headerBottomText,callback:()=>{this.flipHeader()}}),this.constructor.canClose&&(d.close={shortcut:"v",icon:"fa-solid fa-window-close",tooltip:this.constructor.closeText,callback:()=>{this.closed(),this.editor.removeNode(this)}}),this.buttons=d;for(let t in d){let e=d[t],o=E.nodeButton().class(`node-button-${camelCase(t)}`).content(E.i().class(e.icon)).on("click",(t=>{e.callback.call(this,t)}));e.tooltip&&o.data("tooltip",e.tooltip),c.append(o)}let a=(o,s)=>{o.preventDefault(),o.stopPropagation();let n=!1,r=this.left,c=this.top,d=this.width,a=this.height,[h,u]=[0,0];switch(isEmpty(t)||isEmpty(e)||([h,u]=[o.clientX-t,o.clientY-e],h*=1/this.editor.zoom,u*=1/this.editor.zoom),i){case NodeCursorMode.MOVE:r+=h,c+=u,n=!0;break;case NodeCursorMode.RESIZE_N:c+=u,a-=u,n=!0;break;case NodeCursorMode.RESIZE_NE:c+=u,a-=u,d+=h,n=!0;break;case NodeCursorMode.RESIZE_E:d+=h,n=!0;break;case NodeCursorMode.RESIZE_SE:d+=h,a+=u,n=!0;break;case NodeCursorMode.RESIZE_S:a+=u,n=!0;break;case NodeCursorMode.RESIZE_SW:a+=u,r+=h,d-=h,n=!0;break;case NodeCursorMode.RESIZE_W:r+=h,d-=h,n=!0;break;case NodeCursorMode.RESIZE_NW:c+=u,a-=u,r+=h,d-=h,n=!0}n&&(this.setDimension(r,c,d,a,s),this.editor.decorations.recalculate(),this.editor.decorations.draw(),this.resized())};s.append(c),o.append(s).css({left:`${this.left}px`,top:`${this.top}px`,width:`${this.width}px`,height:`${this.height}px`,padding:`${this.constructor.padding}px`}).on("mouseenter",(t=>{this.constructor.hideHeader&&c.css("height",`${this.constructor.headerHeight}px`)})).on("mouseleave",(t=>{this.constructor.hideHeader&&c.css("height","0")})).on("mousemove",(t=>{if(i==NodeCursorMode.NONE){let e=t.target;for(;"ENFUGUE-NODE"!==e.tagName;)e=e.parentElement;if(e!==o.element)return;let s=o.element.getBoundingClientRect(),i=this.constructor.edgeHandlerTolerance*this.editor.zoom,r=this.constructor.headerHeight*this.editor.zoom,c=t.clientY>=s.y&&t.clientY<s.y+i,d=t.clientX>=s.x&&t.clientX<s.x+i,a=t.clientX>=s.x+s.width-i,h=t.clientY>=s.y+s.height-i,u=!0===this.flipped?!h&&t.clientY>=s.y+s.height-r-i:!c&&t.clientY>=s.y&&t.clientY<s.y+i+r;switch(n=c&&d&&this.constructor.canResizeX&&this.constructor.canResizeY?NodeCursorMode.RESIZE_NW:c&&a&&this.constructor.canResizeX&&this.constructor.canResizeY?NodeCursorMode.RESIZE_NE:c&&this.constructor.canResizeY?NodeCursorMode.RESIZE_N:h&&d&&this.constructor.canResizeX&&this.constructor.canResizeY?NodeCursorMode.RESIZE_SW:h&&a&&this.constructor.canResizeX&&this.constructor.canResizeY?NodeCursorMode.RESIZE_SE:h&&this.constructor.canResizeY?NodeCursorMode.RESIZE_S:d&&this.constructor.canResizeX?NodeCursorMode.RESIZE_W:a&&this.constructor.canResizeX?NodeCursorMode.RESIZE_E:u&&this.constructor.canMove&&!d&&!a?NodeCursorMode.MOVE:NodeCursorMode.NONE,n){case NodeCursorMode.MOVE:o.css("cursor","grab");break;case NodeCursorMode.RESIZE_NE:case NodeCursorMode.RESIZE_SW:o.css("cursor","nesw-resize");break;case NodeCursorMode.RESIZE_N:case NodeCursorMode.RESIZE_S:o.css("cursor","ns-resize");break;case NodeCursorMode.RESIZE_E:case NodeCursorMode.RESIZE_W:o.css("cursor","ew-resize");break;case NodeCursorMode.RESIZE_NW:case NodeCursorMode.RESIZE_SE:o.css("cursor","nwse-resize");break;default:o.css("cursor",this.constructor.defaultCursor)}}})).on("mousedown",(s=>{if(1===s.which&&n!==NodeCursorMode.NONE&&i===NodeCursorMode.NONE)switch(s.preventDefault(),s.stopPropagation(),this.editor.focusNode(this),n){case NodeCursorMode.MOVE:case NodeCursorMode.RESIZE_NE:case NodeCursorMode.RESIZE_SW:case NodeCursorMode.RESIZE_N:case NodeCursorMode.RESIZE_S:case NodeCursorMode.RESIZE_E:case NodeCursorMode.RESIZE_W:case NodeCursorMode.RESIZE_NW:case NodeCursorMode.RESIZE_SE:switch([t,e]=[s.clientX,s.clientY],i=n,i){case NodeCursorMode.MOVE:this.editor.node.css("cursor","grab");break;case NodeCursorMode.RESIZE_NE:case NodeCursorMode.RESIZE_SW:this.editor.node.css("cursor","nesw-resize");break;case NodeCursorMode.RESIZE_N:case NodeCursorMode.RESIZE_S:this.editor.node.css("cursor","ns-resize");break;case NodeCursorMode.RESIZE_E:case NodeCursorMode.RESIZE_W:this.editor.node.css("cursor","ew-resize");break;case NodeCursorMode.RESIZE_NW:case NodeCursorMode.RESIZE_SE:this.editor.node.css("cursor","nwse-resize");break;default:this.editor.node.css("cursor",this.constructor.defaultCursor)}let r=s=>{a(s,!0),i=NodeCursorMode.NONE,[t,e]=[null,null],this.editor.node.off("mouseup,mouseleave,mousemove").css("cursor",this.constructor.defaultCursor),o.off("mouseup"),this.editor.constructor.disableCursor&&this.editor.node.css("pointer-events","none")};this.editor.node.on("mousemove",(t=>{t.preventDefault(),t.stopPropagation(),a(t,!1)})).on("mouseup,mouseleave",(t=>{t.preventDefault(),t.stopPropagation(),r(t)})),o.on("mouseup",(t=>{r(t)})),this.editor.constructor.disableCursor&&this.editor.node.css("pointer-events","all")}}));let h=await this.getContent(),u=E.nodeContents();return isEmpty(h)||(h instanceof View&&(h=await h.getNode()),u.content(h)),u.on("mousedown",(t=>{this.editor.focusNode(this)})),this.constructor.fixedHeight||(this.constructor.hideHeader||this.constructor.fixedHeader?u.css("height","100%"):u.css("height",`calc(100% - ${this.constructor.headerHeight}px)`)),s.append(u),o}}class OptionsNodeView extends NodeView{static nodeOptions=null;static optionsHeight=0;constructor(t,e,o,s,i,n,r){super(t,e,o,s,i,n,r),this.options=this.constructor.nodeOptions}async setState(t){if(await super.setState(t),"function"==typeof this.options&&(this.options=new this.options(this.config)),!isEmpty(t.options))if(isEmpty(this.options))console.warn("Options passed, but no options present on node.");else if(this.options instanceof InputView){let e="object"!=typeof t.options||isEmpty(t.options.default)?t.options:t.options.default;await this.options.setValue(e)}else this.options instanceof FormView?(await this.options.setValues(t.options),this.options.submit()):this.options=t.options;return this}async getContent(){let t=E.nodeOptionsContents(),e=E.nodeOptions().css("height",`${this.constructor.optionsHeight}px`);return isEmpty(this.options)||("function"==typeof this.options?(this.options=new this.options(this.config),e.append(await this.options.getNode())):this.options instanceof View?e.append(await this.options.getNode()):e.append(this.options)),t.append(e,await super.getContent()),t}getState(){let t=super.getState();return t.options=isEmpty(this.options)?null:this.options instanceof InputView?this.options.getValue():this.options instanceof FormView?this.options.values:this.options,t}}export{NodeView,OptionsNodeView};
