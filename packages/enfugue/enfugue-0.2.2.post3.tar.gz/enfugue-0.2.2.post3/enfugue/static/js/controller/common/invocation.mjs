import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationTask:"enfugue-invocation-task",invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",invocationSampleChooser:"enfugue-invocation-sample-chooser",invocationSample:"enfugue-invocation-sample",engineStop:"enfugue-engine-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(e){super(e),this.kwargs={}}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(e){this.width!==e&&this.publish("engineWidthChange",e),this.kwargs.width=e}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(e){this.height!==e&&this.publish("engineHeightChange",e),this.kwargs.height=e}get size(){return this.kwargs.size||512}set size(e){this.size!==e&&this.publish("engineSizeChange",e),this.kwargs.size=e}get chunkingSize(){return this.kwargs.chunking_size||this.application.config.model.invocation.chunkingSize}set chunkingSize(e){this.chunkingSize!==e&&this.publish("engineChunkingSizeChange",e),this.kwargs.chunking_size=e}get chunkingBlur(){return this.kwargs.chunking_blur||this.application.config.model.invocation.chunkingBlur}set chunkingBlur(e){this.chunkingBlur!==e&&this.publish("engineChunkingBlurChange",e),this.kwargs.chunking_blur=e}get prompt(){return this.kwargs.prompt||""}get prompt2(){return this.kwargs.prompt_2||""}set prompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.prompt!==i&&this.publish("enginePromptChange",i),this.prompt2!==t&&this.publish("enginePrompt2Change",t),this.kwargs.prompt=i,this.kwargs.prompt_2=t}get negativePrompt(){return this.kwargs.negative_prompt||""}get negativePrompt2(){return this.kwargs.negative_prompt_2||""}set negativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.negativePrompt!==i&&this.publish("engineNegativePromptChange",i),this.negativePrompt2!==t&&this.publish("engineNegativePrompt2Change",t),this.kwargs.negative_prompt=i,this.kwargs.negative_prompt_2=t}get samples(){return this.kwargs.samples||1}set samples(e){this.samples!==e&&this.publish("engineSamplesChange",e),this.kwargs.samples=e}get iterations(){return this.kwargs.iterations||1}set iterations(e){this.iterations!==e&&this.publish("engineIterationsChange",e),this.kwargs.iterations=e}get seed(){return this.kwargs.seed}set seed(e){this.seed!==e&&this.publish("engineSeedChange",e),this.kwargs.seed=e}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(e){this.guidanceScale!==e&&this.publish("engineGuidanceScaleChange",e),this.kwargs.guidance_scale=e}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get model(){return this.kwargs.model}set model(e){this.model!==e&&this.publish("engineModelChange",e),this.kwargs.model=e}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(e){this.modelType!==e&&this.publish("engineModelTypeChange",e),this.kwargs.model_type=e}get outscale(){return this.kwargs.outscale||1}set outscale(e){this.outscale!==e&&this.publish("engineOutscaleChange",e),this.kwargs.outscale=parseInt(e)}get upscale(){return this.kwargs.upscale}set upscale(e){isEquivalent(this.upscale,e)||this.publish("engineUpscaleChange",e),this.kwargs.upscale=e}get upscalePipeline(){return this.kwargs.upscale_pipeline}set upscalePipeline(e){this.upscalePipeline!==e&&this.publish("engineUpscalePipelineChange",e),this.kwargs.upscale_pipeline=e}get upscaleIterative(){return!0===this.kwargs.upscale_iterative}set upscaleIterative(e){this.upscaleIterative!==e&&this.publish("engineUpscaleIterativeChange",e),this.kwargs.upscale_iterative=e}get upscaleDiffusion(){return!0===this.kwargs.upscale_diffusion}set upscaleDiffusion(e){this.upscaleDiffusion!==e&&this.publish("engineUpscaleDiffusionChange",e),this.kwargs.upscale_diffusion=e}get upscaleDiffusionPrompt(){return this.kwargs.upscale_diffusion_prompt}get upscaleDiffusionPrompt2(){return this.kwargs.upscale_diffusion_prompt_2}set upscaleDiffusionPrompt(e){let i=[],t=[];for(let n of e){let e,s;Array.isArray(n)?[e,s]=n:e=n,i.push(e),t.push(s)}isEquivalent(this.upscaleDiffusionPrompt,i)||this.publish("engineUpscaleDiffusionPromptChange",i),isEquivalent(this.upscaleDiffusionPrompt,t)||this.publish("engineUpscaleDiffusionPrompt2Change",t),this.kwargs.upscale_diffusion_prompt=i,this.kwargs.upscale_diffusion_prompt_2=t}get upscaleDiffusionNegativePrompt(){return this.kwargs.upscale_diffusion_negative_prompt}get upscaleDiffusionNegativePrompt2(){return this.kwargs.upscale_diffusion_negative_prompt_2}set upscaleDiffusionNegativePrompt(e){let i=[],t=[];for(let n of e){let e,s;Array.isArray(n)?[e,s]=n:e=n,i.push(e),t.push(s)}isEquivalent(this.upscaleDiffusionNegativePrompt,i)||this.publish("engineUpscaleDiffusionNegativePromptChange",i),isEquivalent(this.upscaleDiffusionNegativePrompt2,t)||this.publish("engineUpscaleDiffusionNegativePrompt2Change",t),this.kwargs.upscale_diffusion_negative_prompt=i,this.kwargs.upscale_diffusion_negative_prompt_2=t}get upscaleDiffusionSteps(){return this.kwargs.upscale_diffusion_steps||this.application.config.model.invocation.upscaleDiffusionSteps}set upscaleDiffusionSteps(e){isEquivalent(this.upscaleDiffusionSteps,e)||this.publish("engineUpscaleDiffusionStepsChange",e),this.kwargs.upscale_diffusion_steps=e}get upscaleDiffusionStrength(){return this.kwargs.upscale_diffusion_strength||this.application.config.model.invocation.upscaleDiffusionStrength}set upscaleDiffusionStrength(e){isEquivalent(this.upscaleDiffusionStrength,e)||this.publish("engineUpscaleDiffusionStrengthChange",e),this.kwargs.upscale_diffusion_strength=e}get upscaleDiffusionGuidanceScale(){return this.kwargs.upscale_diffusion_guidance_scale||this.application.config.model.invocation.upscaleDiffusionGuidanceScale}set upscaleDiffusionGuidanceScale(e){isEquivalent(this.upscaleDiffusionGuidanceScale,e)||this.publish("engineUpscaleDiffusionGuidanceScaleChange",e),this.kwargs.upscale_diffusion_guidance_scale=e}get upscaleDiffusionChunkingSize(){return this.kwargs.upscale_diffusion_chunking_size||this.application.config.model.invocation.upscaleDiffusionChunkingSize}set upscaleDiffusionChunkingSize(e){this.upscaleDiffusionChunkingSize!==e&&this.publish("engineUpscaleDiffusionChunkingSizeChange",e),this.kwargs.upscale_diffusion_chunking_size=e}get upscaleDiffusionChunkingBlur(){return this.kwargs.upscale_diffusion_chunking_blur||this.application.config.model.invocation.upscaleDiffusionChunkingBlur}set upscaleDiffusionChunkingBlur(e){this.upscaleDiffusionChunkingBlur!==e&&this.publish("engineUpscaleDiffusionChunkingBlurChange",e),this.kwargs.upscale_diffusion_chunking_blur=e}get upscaleDiffusionScaleChunkingSize(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_size}set upscaleDiffusionScaleChunkingSize(e){this.upscaleDiffusionScaleChunkingSize!==e&&this.publish("engineUpscaleDiffusionScaleChunkingSizeChange",e),this.kwargs.upscale_diffusion_scale_chunking_size=e}get upscaleDiffusionScaleChunkingBlur(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_blur}set upscaleDiffusionScaleChunkingBlur(e){this.upscaleDiffusionScaleChunkingBlur!==e&&this.publish("engineUpscaleDiffusionScaleChunkingBlurChange",e),this.kwargs.upscale_diffusion_scale_chunking_blur=e}get upscaleDiffusionControlnet(){return this.kwargs.upscale_diffusion_controlnet||null}set upscaleDiffusionControlnet(e){isEquivalent(this.upscaleDiffusionControlnet,e)||this.publish("engineUpscaleDiffusionControlnetChange",e),this.kwargs.upscale_diffusion_controlnet=e}get inversion(){return this.kwargs.inversion||[]}set inversion(e){isEquivalent(this.inversion,e)||this.publish("engineInversionChange",e),this.kwargs.inversion=e}get lora(){return this.kwargs.lora||[]}set lora(e){isEquivalent(this.lora,e)||this.publish("engineLoraChange",e),this.kwargs.lora=e}get lycoris(){return this.kwargs.lycoris||[]}set lycoris(e){isEquivalent(this.lycoris,e)||this.publish("engineLycorisChange",e),this.kwargs.lycoris=e}get refiner(){return this.kwargs.refiner||null}set refiner(e){this.refiner!==e&&this.publish("engineRefinerChange",e),this.kwargs.refiner=e}get refinerSize(){return this.kwargs.refiner_size||null}set refinerSize(e){this.refinerSize!==e&&this.publish("engineRefinerSizeChange",e),this.kwargs.refiner_size=e}get refinerVae(){return this.kwargs.refiner_vae||null}set refinerVae(e){this.refinerVae!==e&&this.publish("engineRefinerVaeChange",e),this.kwargs.refiner_vae=e}get refinerPrompt(){return this.kwargs.refiner_prompt||null}get refinerPrompt2(){return this.kwargs.refiner_prompt_2||null}set refinerPrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerPrompt!==i&&this.publish("engineRefinerPromptChange",i),this.refinerPrompt2!==t&&this.publish("engineRefinerPrompt2Change",t),this.kwargs.refiner_prompt=i,this.kwargs.refiner_prompt_2=t}get refinerNegativePrompt(){return this.kwargs.refiner_negative_prompt||null}get refinerNegativePrompt2(){return this.kwargs.refiner_negative_prompt_2||null}set refinerNegativePrompt(e){let i,t;Array.isArray(e)?[i,t]=e:i=e,this.refinerNegativePrompt!==i&&this.publish("engineRefinerNegativePromptChange",i),this.refinerNegativePrompt2!==t&&this.publish("engineRefinerNegativePrompt2Change",t),this.kwargs.refiner_negative_prompt=i,this.kwargs.refiner_negative_prompt_2=t}get refinerStrength(){return this.kwargs.refiner_strength||.3}set refinerStrength(e){this.refinerStrength!==e&&this.publish("engineRefinerStrengthChange",e),this.kwargs.refiner_strength=e}get refinerGuidanceScale(){return this.kwargs.refiner_guidance_scale||5}set refinerGuidanceScale(e){this.refinerGuidanceScale!==e&&this.publish("engineRefinerGuidanceScaleChange",e),this.kwargs.refiner_guidance_scale=e}get refinerAestheticScore(){return this.kwargs.refiner_aesthetic_score||6}set refinerAestheticScore(e){this.refinerAestheticScore!==e&&this.publish("engineAestheticScoreChange",e),this.kwargs.refiner_aesthetic_score=e}get refinerNegativeAestheticScore(){return this.kwargs.refiner_negative_aesthetic_score||2.5}set refinerNegativeAestheticScore(e){this.refinerNegativeAestheticScore!==e&&this.publish("engineNegativeAestheticScoreChange",e),this.kwargs.refiner_negative_aesthetic_score=e}get inpainter(){return this.kwargs.inpainter||null}set inpainter(e){this.inpainter!==e&&this.publish("engineInpainterChange",e),this.kwargs.inpainter=e}get inpainterSize(){return this.kwargs.inpainter_size||null}set inpainterSize(e){this.inpainterSize!==e&&this.publish("engineInpainterSizeChange",e),this.kwargs.inpainter_size=e}get inpainterVae(){return this.kwargs.inpainter_vae||null}set inpainterVae(e){this.inpainterVae!==e&&this.publish("engineInpainterVaeChange",e),this.kwargs.inpainter_vae=e}get scheduler(){return this.kwargs.scheduler||null}set scheduler(e){this.scheduler!==e&&this.publish("engineSchedulerChange"),this.kwargs.scheduler=e}get vae(){return this.kwargs.vae||null}set vae(e){this.vae!==e&&this.publish("engineVaeChange"),this.kwargs.vae=e}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationTask().hide(),E.invocationRemaining().hide()),this.invocationSampleChooser=E.invocationSampleChooser().hide(),this.engineStop=E.engineStop().content("Stop Engine").on("click",(()=>{this.stopEngine()})),(await this.images.getNode()).append(this.loadingBar).append(this.invocationSampleChooser),this.application.container.appendChild(await this.engineStop.render()),this.subscribe("engineReady",(()=>{this.enableStop()})),this.subscribe("engineBusy",(()=>{this.enableStop()})),this.subscribe("engineIdle",(()=>{this.disableStop()}))}hideSampleChooser(){this.invocationSampleChooser.hide()}enableStop(){this.engineStop.addClass("ready")}disableStop(){this.engineStop.removeClass("ready")}async invoke(e,i=!1){e=isEmpty(e)?{}:e;let t={...this.kwargs,...e},n=await this.application.model.post("invoke",null,null,t);if(this.enableStop(),!isEmpty(n.uuid))if(i){let e=t.prompt.substring(0,this.constructor.truncatePromptLength);e.length===this.constructor.truncatePromptLength&&(e+="..."),await this.startDetachedInvocationMonitor(e,n.uuid,parseInt(t.width)||512,parseInt(t.height)||512)}else await this.canvasInvocation(n.uuid)}async stopEngine(){if(this.engineStop.hasClass("ready")&&await this.confirm("Stop engine and terminate any active invocations?"))try{await this.application.model.post("/invocation/stop"),this.disableStop(),this.notify("info","Stopped","Successfully stopped engine.")}catch(e){let i=`${e}`;isEmpty(e.detail)?isEmpty(e.title)||(i=e.title):i=e.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${i}`)}}async monitorInvocation(e,i,t,n,s){const a=this.application.config.model.invocation.interval||1e3,r=this.application.config.model.queue.interval||5e3,o=this.application.config.model.invocation.errors.consecutive||2;void 0===t&&(t=()=>{}),void 0===i&&(i=()=>{}),void 0===n&&(n=()=>{}),void 0===s&&(s=()=>{});let h,l,g,u,p,c,f,m=(new Date).getTime(),d=async()=>{let v,k;for(let i=0;i<o;i++)try{v=await this.application.model.get(`/invocation/${e}`)}catch(e){k=e}if(isEmpty(v))return this.notify("error","Invocation Error",`${o} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${k}`),void n();if(v.total!==g&&(isEmpty(g)||(m=(new Date).getTime()),g=v.total),v.step!==l&&(l=v.step,c=(new Date).getTime()),v.rate!==u&&(u=v.rate),v.task!==h&&(i(v.task),h=v.task),p=v.duration,!isEmpty(v.images)){let e=v.images.map((e=>`/api/invocation/${e}`)),i="completed"===v.status;t(e,i)}if("error"===v.status)return this.notify("error","Invocation Failed",v.message),void n();if("completed"!==v.status){let e=l/(c-m),i=isEmpty(u)?e:u/1e3,t=(g-l)/(.75*i+.25*e)-((new Date).getTime()-c);isNaN(t)&&(t=1/0),s(t,l,g,u,p),f=setTimeout(d,(e=>"queued"===e.status?r:a)(v))}};d()}setSampleImages(e){let i=this.invocationSampleChooser.children().length;if(isEmpty(e))return this.images.hideCurrentInvocation(),void this.invocationSampleChooser.empty().hide();0===i?(null===this.invocationSampleIndex&&(this.invocationSampleIndex=0),this.invocationSampleChooser.append(E.invocationSample().class("no-sample").content("×").on("click",(()=>{this.invocationSampleIndex=null,this.images.hideCurrentInvocation()})))):i--;for(let t=0;t<e.length;t++){let n=new Image;if(t>=i){n.src=e[t];let i=E.invocationSample().content(n).on("click",(()=>{this.images.setCurrentInvocationImage(e[t]),this.invocationSampleIndex=t}));this.invocationSampleChooser.append(i)}else{let i=this.invocationSampleChooser.getChild(t+1);i.off("click").on("click",(()=>{this.images.setCurrentInvocationImage(e[t]),this.invocationSampleIndex=t})),n.onload=()=>{i.content(n)},n.src=e[t]}}isEmpty(this.invocationSampleIndex)||this.images.setCurrentInvocationImage(e[this.invocationSampleIndex]),this.invocationSampleChooser.show().render()}async canvasInvocation(e){let i,t,n,s,a,r,o,h,l,g,u,p=!1,c=!1,f=(new Date).getTime(),m=f,d=f,v=f,k=this.loadingBar.find(E.getCustomTag("invocationTask")),w=this.loadingBar.find(E.getCustomTag("invocationLoaded")),_=this.loadingBar.find(E.getCustomTag("invocationDuration")),S=this.loadingBar.find(E.getCustomTag("invocationIterations")),C=this.loadingBar.find(E.getCustomTag("invocationRemaining")),b=()=>this.setSampleImages(r),y=()=>{let e=(new Date).getTime();if(c)s<100&&s>0?s+=1:(s=100,p=!0);else if(!isEmpty(t)&&t<1/0){let r=e-d,o=t-(e-n),h=r+o;a=o,i=h,s=r/h*100}m=e,(()=>{let e=m-f;if(_.content(humanDuration(e/1e3)),isEmpty(s))w.css("width","100%"),S.hide(),C.show().content("Initializing…");else if(s<100){C.show().content(humanDuration(a/1e3)),w.css("width",`${s.toFixed(2)}%`);let e=l,i="it/s";!isEmpty(e)&&e<1/0?(e<1&&(e=1/e,i="s/it"),S.show().content(`Iteration ${o}/${h} (${e.toFixed(2)} ${i})`)):S.show().content(`Iteration ${o}/${h}`)}else if(p||isEmpty(g))w.css("width","0"),C.empty().hide();else{C.content("Finalizing step…");let e=h/g,i="it/s";e<1&&(e=1/e,i="s/it"),S.content(`${h} Iterations at ${e.toFixed(2)} ${i}`),w.css("width","100%")}})(),p||requestAnimationFrame((()=>y()))};this.loadingBar.addClass("loading"),this.images.hideCurrentInvocation(),this.invocationSampleChooser.empty(),this.invocationSampleIndex=null,window.requestAnimationFrame((()=>y())),this.monitorInvocation(e,(e=>{u=e,isEmpty(e)?k.empty().hide():k.content(e).show()}),(async(e,i)=>{c=i,e.length>0&&(r=e,b())}),(()=>{c=!0,p=!0,C.empty().hide(),S.empty().hide(),k.empty().hide()}),((e,i,a,r,u)=>{t=e,o!==i&&(v=n),o=i,l=r,g=u,n=(new Date).getTime(),h!==a&&(d=n,isEmpty(h)||(o=0,s=null,v=n)),h=a})),await waitFor((()=>p)),k.empty().hide(),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(e,i,t,n){let s=!1,a=[],r=[];this.monitorInvocation(i,(async(o,h,l)=>{s=!0;for(let s in o){let h=o[s];if(a.length<=s){let o=new ImageInspectorView(this.application.config,h,i),l=await this.spawnWindow(`${e}, sample ${s+1}`,o,t+30,n+90);o.loading(),a.push(l),r.push(o)}else r[s].setImage(h),a[s].setName(`${e}, ${l} elapsed, sample ${s+1}`)}if(h)for(let i in a)a[i].setName(`${e} complete in ${l}, sample ${i+1}`),r[i].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}getDefaultState(){return{samples:null,sample:null}}getState(e=!0){if(!e)return this.getDefaultState();let i=this.invocationSampleChooser.children();return i.length<2?this.getDefaultState():{sample:this.invocationSampleIndex,samples:i.slice(1).map((e=>e.getChild(0).src))}}setState(e){this.invocationSampleChooser.empty(),isEmpty(e)||isEmpty(e.samples)?(this.invocationSampleIndex=null,this.invocationSampleChooser.hide()):(this.invocationSampleIndex=e.sample,this.setSampleImages(e.samples))}}export{InvocationController};
