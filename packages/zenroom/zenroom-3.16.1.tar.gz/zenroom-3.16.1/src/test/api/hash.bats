# setup paths for BATS test units
setup() {
    bats_require_minimum_version 1.5.0
    T="$BATS_TEST_DIRNAME"
    TR=`cd "$T"/.. && pwd`
    R=`cd "$TR"/.. && pwd`
    TMP="$BATS_TEST_TMPDIR"
    load "$TR"/test_helper/bats-support/load
    load "$TR"/test_helper/bats-assert/load
    load "$TR"/test_helper/bats-file/load
    ZTMP="$BATS_FILE_TMPDIR"
    cd $ZTMP
    # vectors
    STR448='abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq'
    STR896='abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu'
}

save() {
    >&3 echo " ðŸ’¾ $1"
    export output=`cat $ZTMP/$1`
}
@test "HASH API :: Compile tests" {
    LDADD="-L$R/meson -lzenroom"
    CFLAGS="$CFLAGS -I$R/src"
    cc ${CFLAGS} -ggdb -o hash_init   $T/hash_init.c ${LDADD}
    cc ${CFLAGS} -ggdb -o hash_update $T/hash_update.c ${LDADD}
    cc ${CFLAGS} -ggdb -o hash_final  $T/hash_final.c ${LDADD}
}

@test "HASH API :: Init SHA512" {
    LD_LIBRARY_PATH=$R/meson ./hash_init sha512 > ctx_sha512
    save ctx_sha512
#    assert_output '40000000000000000000000000000000008c9bcf367e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000'
}


@test "HASH API :: Update SHA512" {
    LD_LIBRARY_PATH=$R/meson ./hash_update `cat ctx_sha512` ${STR448} > ctx_sha512_448
    save ctx_sha512_448
#    assert_output '4c001000000000000000000000000000008c9bcf367e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b6564636264636261676665646665646369686766686766656b6a69686a6968676d6c6b6a6c6b6a696f6e6d6c6e6d6c6b71706f6e706f6e6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000'

    LD_LIBRARY_PATH=$R/meson ./hash_update `cat ctx_sha512` ${STR896} > ctx_sha512_896
    save ctx_sha512_896
#    assert_output '48003000000000000000000000000000008c9bcf367e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b686766656463626169686766656463626a696867666564636b6a6968676665646c6b6a69686766656d6c6b6a696867666e6d6c6b6a6968676f6e6d6c6b6a6968706f6e6d6c6b6a6971706f6e6d6c6b6a7271706f6e6d6c6b737271706f6e6d6c74737271706f6e6d7574737271706f6e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000'
}


@test "HASH API :: Final SHA512" {
    LD_LIBRARY_PATH=$R/meson ./hash_final `cat ctx_sha512_448` > hash_sha512_448
    save hash_sha512_448
    assert_output 'IEqPxt2oLwoM7XvrjgikFlfBbvRosiioJ5vjMacDwzWW/RXBOxsH+aodO+pXeJygMa2Fx6cd1wNU7GMSOMo0RQ=='

    LD_LIBRARY_PATH=$R/meson ./hash_final `cat ctx_sha512_896` > hash_sha512_896
    save hash_sha512_896
    assert_output 'jpWbddrjE9qM9PcoFPwUP493ecbrn3+hcpmurbaIkBhQHSieSQD35DMbmd7EtUM6x9Mp7rbdJlReluVbh0vpCQ=='

}

#####################################
### SHA256

@test "HASH API :: Init SHA256" {
    LD_LIBRARY_PATH=$R/meson ./hash_init sha256 > ctx_sha256
    save ctx_sha256
    # assert_output ''
}
@test "HASH API :: Update SHA256" {
    LD_LIBRARY_PATH=$R/meson ./hash_update `cat ctx_sha256` ${STR448} > ctx_sha256_448
    save ctx_sha256_448
    # assert_output ''
    LD_LIBRARY_PATH=$R/meson ./hash_update `cat ctx_sha256` ${STR896} > ctx_sha256_896
    save ctx_sha256_896
    # assert_output ''
}

@test "HASH API :: Final SHA256" {
    LD_LIBRARY_PATH=$R/meson ./hash_final `cat ctx_sha256_448` > hash_sha256_448
    save hash_sha256_448
    assert_output 'JI1qYdIGOLjlwCaTDD5gOaM85Flk/yFn9uzt1BnbBsE='
    LD_LIBRARY_PATH=$R/meson ./hash_final `cat ctx_sha256_896` > hash_sha256_896
    save hash_sha256_896
    assert_output 'z1sWp3ivg4ADbOWeewSSNwskmxHo8HpRr6xFA3r+6dE='
}
